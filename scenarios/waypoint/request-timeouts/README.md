# üïí Implementing Request Timeouts in Istio using Waypoint

## ‚úÖ Prerequisites

Before proceeding with traffic shifting, ensure that the **Woof App** üê∂ has been deployed by following the steps mentioned in [this guide](https://github.com/falconcr/istio-ambient-workshop/tree/main/scenarios/waypoint/woof-app). It is crucial to have both versions (`v1` and `v2`) of the application running in the `woof` namespace.

---

## üìå Setting up Request Timeouts

To configure request timeouts in Istio using Waypoint, apply the following configuration file:

```sh
kubectl apply -f http-route-request-timeout.yaml
```

This configuration sets a **2-second timeout** for incoming requests to the `woof-service`.

### **HTTPRoute Configuration**

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: woof-route
  namespace: woof
spec:
  parentRefs:
  - kind: Service
    group: ""
    name: woof-service
    port: 80
  rules:
  - backendRefs:
    - name: woof-service-v1
      port: 80
      weight: 50
    - name: woof-service-v2
      port: 80
      weight: 50
    timeouts:
      request: 2s
```

---

## üî¨ Testing the Request Timeout

To validate the timeout setting, we can use `curl-app` to send requests to the `woof-service`.

### **Failure Case (Request exceeding timeout)**
```sh
kubectl -n woof exec curl-app -- bash -c "curl -si woof-service/delay/2"
```

Since we have set a **2-second timeout**, this request is expected to **fail** with the following response:

```
HTTP/1.1 504 Gateway Timeout
content-length: 24
content-type: text/plain
date: Thu, 20 Feb 2025 23:31:01 GMT
server: istio-envoy
x-envoy-decorator-operation: woof-route-0-istio-autogenerated-k8s-gateway:80/*

upstream request timeout
```

### **Successful Case (Request within timeout)**
```sh
kubectl -n woof exec curl-app -- bash -c "curl -si woof-service/delay/1"
```

Since this request completes in **1 second**, it **succeeds** with the following response:

```
HTTP/1.1 200 OK
x-powered-by: Express
content-type: text/html; charset=utf-8
content-length: 368
etag: W/"170-52i+BIwrwxnO8Oqq+G8orjh0khY"
date: Thu, 20 Feb 2025 23:31:54 GMT
x-envoy-upstream-service-time: 1005
server: istio-envoy
x-envoy-decorator-operation: woof-route-0-istio-autogenerated-k8s-gateway:80/*

       .--.             .---.
        /:.  '.         .' ..  '._.---.
       /:::-.  .-"""-; .-:::.     .::      /::'|  /  _ _  \   :'   ::::|
  __.'    |   /  (o|o)       '.   ':/
 /    .:. /   |   ___   |        '---'
|    ::::'   /:  (._.) .:    .='    |:'        :::|
 ""            .-.   ':/
             '---|I|---'
                  '-'

        woof woof v2
```

---

## üéØ Summary
- ‚úÖ Applied an `HTTPRoute` with a **2-second request timeout**.
- ‚úÖ Validated that requests exceeding **2 seconds** result in a `504 Gateway Timeout`.
- ‚úÖ Verified that requests completing within **2 seconds** return a `200 OK` response.

By implementing request timeouts, we ensure that **slow backend responses** do not degrade system performance, improving overall **reliability** and **resilience**. üöÄ

